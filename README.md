# Number Recognition Roadmap

Пошаговый план реализации системы автоматического распознавания и обработки автомобильных номеров согласно ТЗ. После завершения
каждого шага статус должен обновляться в этом документе.

## Статус и шаги

- [x] Шаг 0: Формирование дорожной карты
  - Сформирована структура шагов по ТЗ, зафиксировано требование обновлять статусы после выполнения.
- [x] Шаг 1: Базовая архитектура и каркас сервисов
  - Описана целевая архитектура модулей и форматы обмена данными (docs/architecture.md).
  - Подготовлен каркас репозитория: backend (FastAPI) с базовым API/health, frontend (React+Vite) и общие файлы.
  - Определены основные интерфейсы между модулями и входные/выходные структуры событий.
- [x] Шаг 2: Инфраструктура хранения и конфигурации
  - Спецификация схемы БД PostgreSQL и структуры объектного хранилища S3/MinIO (docs/storage.md).
  - Настроены миграции Alembic, базовые модели пользователей и ролей, подключение конфигурации (env, secrets).
  - Добавлены шаблоны переменных окружения (.env.example) и модуль конфигурации backend.
- [x] Шаг 3: Приём и декодирование видеопотока
  - Добавлен ingest-менеджер и API регистрации каналов с отражением статуса (`/api/v1/ingest/channels`).
  - Описан шаг в `docs/ingest.md`, расширена схема БД (таблица `channels`) и переменные окружения для ingest.
- [x] Шаг 4: Детекция, трекинг и OCR
  - Закреплены интерфейсы `RecognitionPipeline` с конфигурацией детектора, трекера и OCR.
  - Добавлен эндпоинт `/api/v1/pipeline/status` и документация по параметрам (docs/detection.md).
  - Подготовлены переменные окружения для выбора модели YOLO, трекера и OCR-движка.
- [x] Шаг 5: Постобработка, шаблоны стран и антидубликаты
  - Добавлен Postprocessor с нормализацией номера, голосованием по символам и проверкой по шаблонам стран.
  - Настроены антидубликаты и фильтр ложных срабатываний через конфигурацию окружения и новый статус эндпоинт.
- [ ] Шаг 6: Правила, списки и сценарии
  - CRUD для списков (белый/чёрный/информационный), TTL, приоритеты и расписания.
  - Rules Engine с условиями (списки, канал, время, уверенность, направление, антифлуд) и действиями (реле, webhooks, запись клипа, метки).
- [ ] Шаг 7: Сервис событий и уведомлений
  - Event Manager для записи событий в БД и S3, генерация метаданных.
  - Webhook Service с HMAC подписью, повторными отправками и логированием доставок.
  - Alarm Relay Controller с режимами реле, задержками и антидребезгом.
- [ ] Шаг 8: API и авторизация
  - REST API для событий, поиска, каналов, списков, изображений и сценариев.
  - JWT/OAuth2, RBAC (admin/operator/viewer), аудит изменений настрое, TLS для внешних интерфейсов.
- [ ] Шаг 9: Веб-интерфейс администратора и оператора
  - Сетка каналов (1×1, 1×2, 2×2, 2×3, 3×3), вкладки «События», «Поиск», «Списки», «Настройки», «Диагностика».
  - Маскирование номеров для роли viewer, настройка сроков хранения изображений и экспорта (CSV/JSON/PDF).
  - Диагностика FPS, задержек, ошибок OCR и статусов.
- [ ] Шаг 10: Мониторинг, логирование и тестирование
  - Prometheus метрики (задержка, FPS, ошибки OCR, dropped frames), Grafana dashboard, health-check /ready /live.
  - Логи JSON, интеграция с Sentry (опционально), нагрузочные тесты и тестовые видео (день/ночь/дождь/грязь/засвет).
- [ ] Шаг 11: Развёртывание и производственные параметры
  - Docker Compose, варианты для Kubernetes, поддержка GPU (nvidia-container-runtime).
  - Настройка целевых FPS/задержки, поддержка ≥8 каналов на GPU, хранение событий ≥90 суток, маскирование/хеширование при экспорте.
- [ ] Шаг 12: Эксплуатационные сценарии и будущие доработки
  - Подготовка примеров сценариев и экспорта/отчётов (период, фильтры, каналы).
  - Рекомендации по будущим улучшениям: ReID марки/цвета, двухстрочные номера, PTZ управление.

## Примечания
- Каждый завершённый шаг фиксируется галочкой и кратким итогом в списке выше.
- Изменения в шагах или приоритетах фиксируются в рамках ближайшего обновления README.

## Быстрый старт (dev)
1. Клонируйте репозиторий и перейдите в каталог проекта.
2. Скопируйте шаблон окружения и при необходимости задайте значения (локально достаточно оставить значения по умолчанию):
   ```bash
   cp .env.example .env
   ```
3. Запустите backend:
   ```bash
   cd backend
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   alembic upgrade head  # применить миграции (требуется доступ к БД)
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```
4. Frontend будет развёрнут начиная с шага 9 (React + Vite). После инициализации используйте:
   ```bash
   cd frontend
   npm install
   npm run dev
   ```
5. Регистрация тестового канала ingest (опционально, после запуска backend):
   ```bash
   curl -X POST http://localhost:8000/api/v1/ingest/channels \
     -H "Content-Type: application/json" \
     -d '{
       "channel_id": "demo-rtsp",
       "name": "Demo RTSP",
       "source": "rtsp://user:pass@camera/stream",
       "target_fps": 12,
       "reconnect_seconds": 3,
       "decoder_priority": ["nvdec", "vaapi", "cpu"],
       "direction": "any"
     }'
   ```
6. Проверка конфигурации детектора/трекера/OCR (шаг 4):
   ```bash
   curl http://localhost:8000/api/v1/pipeline/status | jq
   ```
7. В ответе появится блок `postprocess` (шаг 5) с текущими порогами, шаблонами стран и настройками антидубликатов.
