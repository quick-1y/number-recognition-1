# Архитектура системы распознавания номерных знаков

Этот документ фиксирует целевую архитектуру и интерфейсы модулей, соответствующие шагу 1 дорожной карты. Архитектура может уточняться на следующих шагах, но высокоуровневые контуры должны оставаться стабильными.

## Модули конвейера

1. **Ingest** — приём видеопотоков (RTSP/ONVIF/файлы) с авто-переподключением и выравниванием FPS.
2. **VideoDecoder** — аппаратное/программное декодирование (NVDEC/VAAPI/CPU) и базовая подготовка кадров.
3. **Motion/Trigger** — фильтрация по движению или внешним событиям (ONVIF).
4. **Detector** — YOLO-вариант, отдаёт bbox номерного знака + confidence.
5. **Tracker** — ByteTrack/SORT, формирует `track_id`, направление и временные метки трека.
6. **Cropper** — извлечение области номерного знака из кадра.
7. **OCR Engine** — EasyOCR/PaddleOCR/custom CRNN с голосованием по кадрам.
8. **Postprocessor** — нормализация строки номера, коррекция символов, проверка шаблонов стран и голосование по символам.
9. **Rules Engine** — IF/THEN сценарии (списки, расписания, уверенность, направление, антифлуд) и действия (реле, webhooks, запись клипа, метки).
10. **Event Manager** — запись событий в БД и S3, построение метаданных, антидубликаты по трекам.
11. **Webhook Service** — HMAC подпись, повторные отправки с backoff, логирование доставок.
12. **Alarm Relay Controller** — управление тревожными выходами камер с антидребезгом и режимами реле.
13. **Admin/API/UI** — внешние интерфейсы управления и мониторинга.
14. **Monitoring/Logging** — метрики Prometheus, health-checks, аудит изменений и JSON-логи.

## Логический поток данных

1. Ingest получает кадры и метаданные канала (id, ROI, направление) → VideoDecoder.
2. VideoDecoder нормализует кадры → Detector (учитывая ROI/маску).
3. Detector выдаёт bbox + confidence → Tracker, который присваивает `track_id` и направление.
4. Cropper обрезает область номера для OCR → OCR Engine.
5. OCR Engine возвращает массив гипотез по кадрам → Postprocessor выполняет голосование и коррекцию.
6. Postprocessor отдаёт нормализованный номер + confidence → Rules Engine.
7. Rules Engine применяет списки/расписания → Event Manager.
8. Event Manager сохраняет событие в PostgreSQL + S3/MinIO, обогащает метаданными (bbox, track, timestamps).
9. Webhook Service и Alarm Relay Controller получают события/действия из Event Manager.
10. Admin/API/UI читает события и управление из БД/объектного хранилища, Monitoring/Logging собирает метрики и логи.

## Основные интерфейсы и форматы обмена

- **Кадр**: `Frame { channel_id, ts, image, roi, direction_hint }`
- **Детекция**: `Detection { bbox, score, class="plate" }`
- **Трек**: `Track { track_id, bbox, direction, first_ts, last_ts }`
- **OCR результат (raw)**: `OcrHypothesis { text, confidence, frame_ts }`
- **Постобработка**: `PlateCandidate { plate, confidence, country_template, corrections }`
- **Событие**: `RecognitionEvent { id, channel, plate, confidence, template, track_id, bbox, direction, timestamps, image_url, metadata }`
- **Webhook**: подписка содержит URL, заголовки, HMAC секрет, политику ретраев; тело события — JSON формата `RecognitionEvent` + `Idempotency-Key`.

## Модули и пакеты в репозитории

- `backend/` — FastAPI сервис: REST API, обработка событий, управление конфигурацией, интеграции (webhook, реле), метрики.
- `frontend/` — веб-клиент (React + Vite): интерфейсы оператора/админа, вкладки событий, поиска, списков и настроек.
- `docs/` — документация по архитектуре, схемам БД и потокам данных.
- `deploy/` (будет добавлен на шаге 11) — Docker Compose/K8s манифесты, настройки GPU.

## Обновление и расширение

- Архитектура должна поддерживать горизонтальное масштабирование ingest/детекции через очереди (например, в шаге 3/4 можно добавить Kafka/NATS при необходимости).
- API версии фиксируются через префиксы (`/api/v1`).
- Список шаблонов стран хранится в конфигурации и может обновляться без остановки сервиса.
- Хранилище изображений абстрагировано интерфейсом (S3/MinIO); смена провайдера требует реализации адаптера.
